services:
    file-upload-service:
        build:
            context: ./services/file_upload_service
            dockerfile: Dockerfile
        restart: unless-stopped

        ports:
            - "8080:8080"
        environment:
            S3_BUCKET: files
            S3_REGION: us-east-1
            MINIO_SERVER_URL: ${MINIO_SERVER_URL}
            MINIO_ROOT_USER: ${MINIO_ROOT_USER}
            MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}

        depends_on:
            minio:
                condition: service_healthy
            auth_service:
                condition: service_healthy


    auth_service:
        build:
            context: ./services/auth_service
            dockerfile: Dockerfile
        restart: unless-stopped
        ports:
            - "8000:8000"
        environment:
            AUTH_SERVICE_WORKERS: ${AUTH_SERVICE_WORKERS}
            POSTGRES_USER: ${POSTGRES_USER}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
            POSTGRES_DB: ${POSTGRES_DB}

        healthcheck:
            test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_interval: 10s

        depends_on:
            redis:
                condition: service_healthy
            postgres:
                condition: service_healthy

    minio:
        image: minio/minio
        restart: unless-stopped
        ports:
            - "9000:9000" # API
            - "9001:9001" # UI

        environment:
            MINIO_ROOT_USER: ${MINIO_ROOT_USER}
            MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}

        volumes:
            - ./minio-data:/data
        command: server --console-address ":9001" /data
        healthcheck:
            test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
            interval: 30s
            timeout: 20s
            retries: 3
            start_interval: 5s

    postgres:
        image: postgres:latest
        restart: unless-stopped
        ports:
            - "5432:5432"
        environment:
            POSTGRES_USER: ${POSTGRES_USER}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
            POSTGRES_DB: ${POSTGRES_DB}
        volumes:
            - ./postgres_data:/var/lib/postgresql/data
        healthcheck:
            test: [ "CMD-SHELL", "sh -c 'pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}'"]
            interval: 10s
            timeout: 3s
            retries: 3
            start_interval: 10s

    redis:
        image: redis:latest
        restart: unless-stopped
        ports:
            - "6379:6379"
        command: [ "redis-server", "--requirepass", "${REDIS_PASSWORD}" ]

        healthcheck:
            test: [ "CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping" ]
            interval: 30s
            timeout: 10s
            retries: 3